<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç½‘åº—è´¦å•åŠ©æ‰‹ (äº‘åŒæ­¥ç‰ˆ)</title>
  
  <!-- 
    === éƒ¨ç½²ä¸äº‘åŒæ­¥æŒ‡å— ===
    1. æœ¬åœ°ä½¿ç”¨ï¼šç›´æ¥æ‰“å¼€å³å¯ï¼Œæ•°æ®ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨ã€‚
    2. äº‘ç«¯åŒæ­¥ï¼š
       - å» https://console.firebase.google.com åˆ›å»ºä¸€ä¸ªå…è´¹é¡¹ç›®ã€‚
       - å¯ç”¨ "Authentication" (å¼€å¯ Google ç™»å½•)ã€‚
       - å¯ç”¨ "Firestore Database" (åˆ›å»ºæ•°æ®åº“)ã€‚
       - åœ¨è®¾ç½®ä¸­æ‰¾åˆ° "SDK setup and configuration"ï¼Œå¤åˆ¶ const firebaseConfig = {...} çš„å†…å®¹ã€‚
       - ç‚¹å‡»æœ¬ç½‘é¡µå³ä¸Šè§’çš„â€œäº‘åŒæ­¥â€æŒ‰é’®ï¼Œå¡«å…¥é…ç½®å³å¯ã€‚
  -->

  <!-- 1. Styles (Tailwind CSS) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              900: '#0c4a6e',
            }
          }
        }
      }
    }
  </script>

  <!-- 2. React Core -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- 3. Recharts Dependencies -->
  <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

  <!-- 4. Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 5. Firebase (Compat version for simple HTML usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(4px); }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 text-slate-900 antialiased selection:bg-brand-100 selection:text-brand-900">
  <div id="root"></div>

  <!-- Application Logic -->
  <script type="text/babel">
    // --- Warning Suppression ---
    const originalConsoleError = console.error;
    console.error = (...args) => {
      if (typeof args[0] === 'string' && args[0].includes('defaultProps')) return;
      originalConsoleError(...args);
    };

    const { useState, useEffect, useMemo, useRef } = React;
    const { 
      BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
      LineChart, Line, PieChart, Pie, Cell 
    } = Recharts;

    // --- CONSTANTS ---
    const DEFAULT_CATEGORIES = [
      { id: 'inc_sales', name: 'å•†å“é”€å”®', icon: 'ğŸ›ï¸', color: '#10b981', type: 'income' },
      { id: 'inc_service', name: 'ä»£è´­æœåŠ¡', icon: 'ğŸ¤', color: '#34d399', type: 'income' },
      { id: 'inc_refund', name: 'å¹³å°é€€æ¬¾', icon: 'â†©ï¸', color: '#6ee7b7', type: 'income' },
      { id: 'inc_other', name: 'å…¶ä»–æ”¶å…¥', icon: 'ğŸ’°', color: '#a7f3d0', type: 'income' },
      { id: 'exp_stock', name: 'è¿›è´§æˆæœ¬', icon: 'ğŸ“¦', color: '#f43f5e', type: 'expense' },
      { id: 'exp_logistics', name: 'å¿«é€’ç‰©æµ', icon: 'ğŸšš', color: '#fb7185', type: 'expense' },
      { id: 'exp_marketing', name: 'å¹¿å‘Šæ¨å¹¿', icon: 'ğŸ“£', color: '#fda4af', type: 'expense' },
      { id: 'exp_packaging', name: 'åŒ…è£…è€—æ', icon: 'ğŸ€', color: '#fecdd3', type: 'expense' },
      { id: 'exp_platform', name: 'å¹³å°æ‰£ç‚¹', icon: 'ğŸ§¾', color: '#e11d48', type: 'expense' },
      { id: 'exp_other', name: 'æ‚é¡¹æ”¯å‡º', icon: 'ğŸ’¸', color: '#be123c', type: 'expense' },
    ];

    const formatCurrency = (amount) => new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY', minimumFractionDigits: 2 }).format(amount);
    const formatDate = (dateStr) => new Intl.DateTimeFormat('zh-CN', { month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }).format(new Date(dateStr));
    const getCategoryIcon = (categoryName) => {
      const found = DEFAULT_CATEGORIES.find(c => c.name === categoryName);
      if (found) return found.icon;
      if (categoryName.includes('åƒ') || categoryName.includes('é¤')) return 'ğŸ”';
      if (categoryName.includes('è½¦') || categoryName.includes('è¡Œ')) return 'ğŸš•';
      if (categoryName.includes('æˆ¿') || categoryName.includes('ç§Ÿ')) return 'ğŸ ';
      return 'âœ¨';
    };

    // --- FIREBASE SERVICE ---
    // Manages connection to Firebase if config is present
    const useFirebase = () => {
      const [user, setUser] = useState(null);
      const [db, setDb] = useState(null);
      const [isConfigured, setIsConfigured] = useState(false);

      useEffect(() => {
        const storedConfig = localStorage.getItem('shop_ledger_firebase_config');
        if (storedConfig) {
          try {
            const config = JSON.parse(storedConfig);
            if (!firebase.apps.length) {
              firebase.initializeApp(config);
            }
            setDb(firebase.firestore());
            setIsConfigured(true);
            
            const unsubscribe = firebase.auth().onAuthStateChanged((u) => {
              setUser(u);
            });
            return () => unsubscribe();
          } catch (e) {
            console.error("Firebase init failed:", e);
          }
        }
      }, []);

      const login = async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await firebase.auth().signInWithPopup(provider);
        } catch (error) {
          if (error.code === 'auth/unauthorized-domain') {
             alert(`âš ï¸ åŸŸåæœªæˆæƒ\n\nè¯·å‰å¾€ Firebase Console -> Authentication -> Settings -> Authorized Domains\næ·»åŠ æ­¤åŸŸå: ${window.location.hostname}`);
          } else {
             alert("ç™»å½•å¤±è´¥: " + error.message);
          }
        }
      };

      const logout = async () => {
        await firebase.auth().signOut();
      };

      const saveConfig = (configStr) => {
        try {
          // Validate JSON
          const config = JSON.parse(configStr);
          if (!config.apiKey || !config.projectId) throw new Error("Invalid Config");
          localStorage.setItem('shop_ledger_firebase_config', configStr);
          window.location.reload(); // Reload to init firebase
        } catch (e) {
          alert("é…ç½®æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿æ˜¯åˆæ³•çš„ JSON å¯¹è±¡ã€‚");
        }
      };

      const removeConfig = () => {
        if(confirm("ç¡®å®šè¦ç§»é™¤äº‘ç«¯é…ç½®å¹¶åˆ‡å›æœ¬åœ°æ¨¡å¼å—ï¼Ÿ")) {
          localStorage.removeItem('shop_ledger_firebase_config');
          window.location.reload();
        }
      };

      return { user, db, isConfigured, login, logout, saveConfig, removeConfig };
    };

    // --- COMPONENTS ---

    // 0. Config Modal
    const ConfigModal = ({ isOpen, onClose, firebaseHook }) => {
      const [configInput, setConfigInput] = useState('');
      
      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
          <div className="bg-white rounded-3xl p-6 max-w-lg w-full shadow-2xl animate-fade-in relative overflow-hidden">
            <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
              â˜ï¸ äº‘åŒæ­¥è®¾ç½® (Firebase)
            </h2>
            
            {firebaseHook.isConfigured ? (
               <div className="space-y-4">
                 <div className="p-4 bg-emerald-50 text-emerald-700 rounded-xl border border-emerald-100 flex items-center gap-2">
                   <span className="text-xl">âœ…</span>
                   <div>
                     <p className="font-bold">äº‘æœåŠ¡å·²è¿æ¥</p>
                     <p className="text-xs opacity-80">æ‚¨çš„æ•°æ®å°†åŒæ­¥åˆ° Google Firestore</p>
                   </div>
                 </div>
                 
                 {firebaseHook.user ? (
                   <div className="flex items-center justify-between bg-slate-50 p-3 rounded-xl">
                     <div className="flex items-center gap-2">
                       <img src={firebaseHook.user.photoURL} className="w-8 h-8 rounded-full" />
                       <span className="text-sm font-medium">{firebaseHook.user.displayName}</span>
                     </div>
                     <button onClick={firebaseHook.logout} className="text-sm text-red-500 hover:underline">é€€å‡º</button>
                   </div>
                 ) : (
                   <button onClick={firebaseHook.login} className="w-full py-3 bg-brand-500 hover:bg-brand-600 text-white rounded-xl font-bold transition-colors flex items-center justify-center gap-2">
                     <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.033-6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                     ä½¿ç”¨ Google è´¦å·ç™»å½•
                   </button>
                 )}

                 <div className="border-t pt-4 mt-4">
                    <button onClick={firebaseHook.removeConfig} className="text-xs text-slate-400 hover:text-red-500">ç§»é™¤é…ç½® (åˆ‡å›ç¦»çº¿æ¨¡å¼)</button>
                 </div>
               </div>
            ) : (
              <div className="space-y-4">
                <p className="text-sm text-slate-600">
                  è¦å¯ç”¨å¤šè®¾å¤‡åŒæ­¥ï¼Œè¯·ç²˜è´´æ‚¨çš„ Firebase Config JSON å¯¹è±¡ã€‚
                  <br/><span className="text-xs text-slate-400">è¯·å‰å¾€ Firebase Console -> Project Settings -> General å¤åˆ¶ SDK é…ç½®ã€‚</span>
                </p>
                <textarea 
                  className="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl font-mono text-xs focus:ring-2 focus:ring-brand-500 focus:outline-none"
                  placeholder='{ "apiKey": "...", "authDomain": "...", ... }'
                  value={configInput}
                  onChange={e => setConfigInput(e.target.value)}
                />
                <button 
                  onClick={() => firebaseHook.saveConfig(configInput)}
                  className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-colors"
                >
                  ä¿å­˜å¹¶è¿æ¥
                </button>
              </div>
            )}
            
            <div className="mt-6 pt-4 border-t border-slate-100">
                <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-2">Troubleshooting</p>
                <div className="bg-slate-50 rounded-lg p-3 text-xs text-slate-600">
                    <p className="mb-1">å¦‚æœç™»å½•æŠ¥é”™ <strong>unauthorized-domain</strong>ï¼Œè¯·åœ¨ Firebase æ§åˆ¶å°æ·»åŠ æ­¤åŸŸåï¼š</p>
                    <code className="block bg-white border border-slate-200 p-1.5 rounded font-mono text-center select-all cursor-pointer hover:border-brand-300" onClick={(e) => {
                        window.getSelection().selectAllChildren(e.target);
                    }}>
                        {window.location.hostname}
                    </code>
                </div>
            </div>

            <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600">âœ•</button>
          </div>
        </div>
      );
    };

    // 1. TransactionForm (Unchanged visual, props handled by parent)
    const TransactionForm = ({ onAddTransaction, isSaving }) => {
      const [type, setType] = useState('income');
      const [amount, setAmount] = useState('');
      const [category, setCategory] = useState('');
      const [description, setDescription] = useState('');

      const availableCategories = DEFAULT_CATEGORIES.filter(c => c.type === type);

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!amount || !category) return;
        onAddTransaction({ type, amount: parseFloat(amount), category, description });
        setAmount(''); setDescription(''); setCategory('');
      };

      return (
        <div className="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 sticky top-4 z-20">
          <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span className="text-2xl">ğŸ“</span> è®°ä¸€ç¬”
          </h2>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="flex bg-slate-100 p-1 rounded-xl">
              <button type="button" onClick={() => { setType('income'); setCategory(''); }} className={`flex-1 py-2 rounded-lg text-sm font-semibold transition-all ${type === 'income' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>æ”¶å…¥ ğŸ’°</button>
              <button type="button" onClick={() => { setType('expense'); setCategory(''); }} className={`flex-1 py-2 rounded-lg text-sm font-semibold transition-all ${type === 'expense' ? 'bg-white text-rose-500 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>æ”¯å‡º ğŸ’¸</button>
            </div>
            <div className="relative">
              <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">Â¥</span>
              <input type="number" step="0.01" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0.00" className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 text-lg font-bold text-slate-800 placeholder-slate-300" required />
            </div>
            <div className="grid grid-cols-4 gap-2">
              {availableCategories.map((cat) => (
                <button key={cat.id} type="button" onClick={() => setCategory(cat.name)} className={`flex flex-col items-center justify-center p-2 rounded-xl border transition-all ${category === cat.name ? type === 'income' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-rose-500 bg-rose-50 text-rose-700' : 'border-slate-100 bg-white hover:border-slate-300 text-slate-600'}`}>
                  <span className="text-xl mb-1">{cat.icon}</span>
                  <span className="text-xs truncate w-full text-center">{cat.name}</span>
                </button>
              ))}
            </div>
            <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="å¤‡æ³¨ (é€‰å¡«)" className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 text-sm text-slate-700" />
            <button disabled={isSaving} type="submit" className={`w-full py-3 rounded-xl font-bold text-white shadow-lg shadow-brand-500/30 active:scale-95 transition-transform disabled:opacity-50 disabled:cursor-not-allowed ${type === 'income' ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-rose-500 hover:bg-rose-600'}`}>
              {isSaving ? 'ä¿å­˜ä¸­...' : `ç¡®è®¤${type === 'income' ? 'å…¥è´¦' : 'æ”¯å‡º'}`}
            </button>
          </form>
        </div>
      );
    };

    // 2. StatsOverview
    const StatsOverview = ({ totalIncome, totalExpense }) => {
      const netProfit = totalIncome - totalExpense;
      return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          <div className="bg-emerald-500 rounded-3xl p-6 text-white shadow-lg shadow-emerald-500/20 relative overflow-hidden group">
            <div className="absolute -right-4 -top-4 text-8xl opacity-10 rotate-12 group-hover:scale-110 transition-transform">ğŸ›ï¸</div>
            <p className="text-emerald-100 text-sm font-medium mb-1">æ€»æ”¶å…¥</p>
            <p className="text-3xl font-bold">{formatCurrency(totalIncome)}</p>
          </div>
          <div className="bg-rose-500 rounded-3xl p-6 text-white shadow-lg shadow-rose-500/20 relative overflow-hidden group">
            <div className="absolute -right-4 -top-4 text-8xl opacity-10 rotate-12 group-hover:scale-110 transition-transform">ğŸ’¸</div>
            <p className="text-rose-100 text-sm font-medium mb-1">æ€»æ”¯å‡º</p>
            <p className="text-3xl font-bold">{formatCurrency(totalExpense)}</p>
          </div>
          <div className={`rounded-3xl p-6 text-white shadow-lg relative overflow-hidden group ${netProfit >= 0 ? 'bg-indigo-600 shadow-indigo-600/20' : 'bg-slate-700 shadow-slate-700/20'}`}>
            <div className="absolute -right-4 -top-4 text-8xl opacity-10 rotate-12 group-hover:scale-110 transition-transform">âœ¨</div>
            <p className="text-indigo-100 text-sm font-medium mb-1">å‡€åˆ©æ¶¦</p>
            <p className="text-3xl font-bold">{formatCurrency(netProfit)}</p>
          </div>
        </div>
      );
    };

    // 3. AnalysisCharts (Updated YAxis logic)
    const COLORS_INCOME = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0'];
    const COLORS_EXPENSE = ['#f43f5e', '#fb7185', '#fda4af', '#fecdd3', '#e11d48', '#be123c'];

    const CustomTooltip = ({ active, payload, label }) => {
      if (active && payload && payload.length) {
        return (
          <div className="bg-white/95 backdrop-blur-sm p-4 border border-slate-200 rounded-xl shadow-xl text-sm z-50">
            <p className="font-bold text-slate-700 mb-2">{label}</p>
            {payload.map((entry, index) => (
              <p key={index} style={{ color: entry.color }} className="flex items-center gap-2">
                <span>{entry.name}:</span>
                <span className="font-mono font-bold">{typeof entry.value === 'number' ? `Â¥${entry.value.toFixed(2)}` : entry.value}</span>
              </p>
            ))}
          </div>
        );
      }
      return null;
    };

    const formatYAxis = (value) => {
      if (value === 0) return 'Â¥0';
      if (Math.abs(value) < 1000) return `Â¥${value}`;
      return `Â¥${(value / 1000).toFixed(1)}k`;
    };

    const renderPieLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent }) => {
      const RADIAN = Math.PI / 180;
      const radius = innerRadius + (outerRadius - innerRadius) * 0.5; 
      const x = cx + radius * Math.cos(-midAngle * RADIAN); 
      const y = cy + radius * Math.sin(-midAngle * RADIAN);
      if (percent < 0.05) return null;
      return <text x={x} y={y} fill="white" textAnchor="middle" dominantBaseline="central" fontSize={11} fontWeight="bold" style={{ textShadow: '0px 1px 2px rgba(0,0,0,0.5)' }}>{`${(percent * 100).toFixed(1)}%`}</text>;
    };

    const AnalysisCharts = ({ transactions }) => {
      const monthlyData = useMemo(() => {
        const map = new Map();
        transactions.forEach(t => {
          const date = new Date(t.date);
          const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          const label = `${date.getFullYear()}å¹´${String(date.getMonth() + 1).padStart(2, '0')}æœˆ`;
          if (!map.has(key)) map.set(key, { monthKey: key, income: 0, expense: 0, profit: 0, label });
          const stat = map.get(key);
          if (t.type === 'income') stat.income += t.amount; else stat.expense += t.amount;
          stat.profit = stat.income - stat.expense;
        });
        return Array.from(map.values()).sort((a, b) => a.monthKey.localeCompare(b.monthKey));
      }, [transactions]);

      const getCategoryStats = (type) => {
        const map = new Map();
        transactions.filter(t => t.type === type).forEach(t => map.set(t.category, (map.get(t.category) || 0) + t.amount));
        return Array.from(map.entries()).map(([name, value]) => {
          const def = DEFAULT_CATEGORIES.find(c => c.name === name);
          return { name, value, icon: def ? def.icon : getCategoryIcon(name), color: def ? def.color : '#94a3b8' };
        }).sort((a, b) => b.value - a.value);
      };

      const incomeStats = useMemo(() => getCategoryStats('income'), [transactions]);
      const expenseStats = useMemo(() => getCategoryStats('expense'), [transactions]);
      const totalIncomeVal = incomeStats.reduce((acc, curr) => acc + curr.value, 0);
      const totalExpenseVal = expenseStats.reduce((acc, curr) => acc + curr.value, 0);

      if (transactions.length === 0) return <div className="flex flex-col items-center justify-center h-64 bg-white rounded-3xl p-8 text-slate-400 border border-slate-100 border-dashed"><span className="text-4xl mb-4">ğŸ“Š</span><p>æš‚æ— æ•°æ®ï¼Œè¯·å…ˆè®°ä¸€ç¬”è´¦å§ï¼</p></div>;

      return (
        <div className="space-y-8">
          <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
            <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><span>ğŸ“…</span> æœˆåº¦æ”¶æ”¯å¯¹æ¯”</h3>
            <div className="h-72"><ResponsiveContainer width="100%" height="100%"><BarChart data={monthlyData} margin={{ top: 10, right: 10, left: 20, bottom: 0 }}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#64748b" opacity={0.4} /><XAxis dataKey="label" axisLine={false} tickLine={false} tick={{ fill: '#475569', fontSize: 12, fontWeight: 500 }} dy={10} /><YAxis axisLine={false} tickLine={false} tick={{ fill: '#475569', fontSize: 12 }} tickFormatter={formatYAxis} width={60} /><Tooltip content={<CustomTooltip />} cursor={{ fill: '#f8fafc' }} /><Legend iconType="circle" /><Bar dataKey="income" name="æ”¶å…¥" fill="#10b981" radius={[4, 4, 0, 0]} barSize={20} /><Bar dataKey="expense" name="æ”¯å‡º" fill="#f43f5e" radius={[4, 4, 0, 0]} barSize={20} /></BarChart></ResponsiveContainer></div>
          </div>
          <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
            <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><span>ğŸ“ˆ</span> å‡€åˆ©æ¶¦è¶‹åŠ¿</h3>
            <div className="h-72"><ResponsiveContainer width="100%" height="100%"><LineChart data={monthlyData} margin={{ top: 10, right: 10, left: 20, bottom: 0 }}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#64748b" opacity={0.4} /><XAxis dataKey="label" axisLine={false} tickLine={false} tick={{ fill: '#475569', fontSize: 12, fontWeight: 500 }} dy={10} /><YAxis axisLine={false} tickLine={false} tick={{ fill: '#475569', fontSize: 12 }} tickFormatter={formatYAxis} width={60} /><Tooltip content={<CustomTooltip />} /><Legend /><Line type="monotone" dataKey="profit" name="å‡€åˆ©æ¶¦" stroke="#4f46e5" strokeWidth={3} dot={{ r: 4, strokeWidth: 2, fill: '#fff' }} activeDot={{ r: 6 }} /></LineChart></ResponsiveContainer></div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center">
              <h3 className="text-lg font-bold text-slate-800 mb-4 w-full flex items-center gap-2"><span>ğŸ’°</span> æ”¶å…¥æ„æˆ</h3>
              <div className="w-full h-64"><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={incomeStats} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value" label={renderPieLabel} labelLine={false}>{incomeStats.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS_INCOME[index % COLORS_INCOME.length]} />)}</Pie><Tooltip /></PieChart></ResponsiveContainer></div>
              <div className="w-full flex flex-wrap gap-2 justify-center mt-4">{incomeStats.map((stat, i) => <div key={i} className="flex items-center gap-1 text-xs text-slate-600 bg-slate-50 px-2 py-1 rounded-md border border-slate-100"><span className="w-2 h-2 rounded-full" style={{backgroundColor: COLORS_INCOME[i % COLORS_INCOME.length]}}></span><span>{stat.icon} {stat.name} <span className="font-bold">{totalIncomeVal > 0 ? ((stat.value / totalIncomeVal) * 100).toFixed(1) : 0}%</span></span></div>)}</div>
            </div>
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center">
              <h3 className="text-lg font-bold text-slate-800 mb-4 w-full flex items-center gap-2"><span>ğŸ’¸</span> æ”¯å‡ºæ„æˆ</h3>
              <div className="w-full h-64"><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={expenseStats} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value" label={renderPieLabel} labelLine={false}>{expenseStats.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS_EXPENSE[index % COLORS_EXPENSE.length]} />)}</Pie><Tooltip /></PieChart></ResponsiveContainer></div>
              <div className="w-full flex flex-wrap gap-2 justify-center mt-4">{expenseStats.map((stat, i) => <div key={i} className="flex items-center gap-1 text-xs text-slate-600 bg-slate-50 px-2 py-1 rounded-md border border-slate-100"><span className="w-2 h-2 rounded-full" style={{backgroundColor: COLORS_EXPENSE[i % COLORS_EXPENSE.length]}}></span><span>{stat.icon} {stat.name} <span className="font-bold">{totalExpenseVal > 0 ? ((stat.value / totalExpenseVal) * 100).toFixed(1) : 0}%</span></span></div>)}</div>
            </div>
          </div>
        </div>
      );
    };

    // 4. TransactionList
    const TransactionList = ({ transactions, onDelete, isReadOnly }) => {
      const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
      if (transactions.length === 0) return null;
      return (
        <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
          <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><span>ğŸ•’</span> è¿‘æœŸè´¦å•</h3>
          <div className="space-y-4">
            {sortedTransactions.map((t) => (
              <div key={t.id} className="group flex items-center justify-between p-4 hover:bg-slate-50 rounded-2xl border border-transparent hover:border-slate-100 transition-all">
                <div className="flex items-center gap-4">
                  <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl ${t.type === 'income' ? 'bg-emerald-100' : 'bg-rose-100'}`}>{getCategoryIcon(t.category)}</div>
                  <div>
                    <p className="font-bold text-slate-800">{t.category}</p>
                    <div className="flex items-center gap-2 text-xs text-slate-400"><span>{formatDate(t.date)}</span>{t.description && <span>â€¢ {t.description}</span>}</div>
                  </div>
                </div>
                <div className="flex items-center gap-4">
                  <span className={`font-bold font-mono text-lg ${t.type === 'income' ? 'text-emerald-600' : 'text-rose-500'}`}>{t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount)}</span>
                  {!isReadOnly && <button onClick={() => onDelete(t.id)} className="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-red-500 transition-all" title="åˆ é™¤"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // 5. Main App
    function App() {
      // Logic State
      const firebaseHook = useFirebase();
      const [transactions, setTransactions] = useState([]);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [isSaving, setIsSaving] = useState(false);
      const fileInputRef = useRef(null);

      // --- DATA LOADING LOGIC ---
      
      // Mode 1: LocalStorage (Default)
      useEffect(() => {
        // Only load from local if NOT using firebase or user not logged in
        if (!firebaseHook.isConfigured || !firebaseHook.user) {
          try {
            const saved = localStorage.getItem('shop_ledger_transactions');
            if (saved) setTransactions(JSON.parse(saved));
          } catch (e) {
            console.error(e);
          }
        }
      }, [firebaseHook.isConfigured, firebaseHook.user]);

      // Mode 2: Firebase Realtime Listener
      useEffect(() => {
        if (firebaseHook.isConfigured && firebaseHook.user && firebaseHook.db) {
          // Listen to collection: users/{uid}/transactions
          const unsubscribe = firebaseHook.db
            .collection('users')
            .doc(firebaseHook.user.uid)
            .collection('transactions')
            .onSnapshot((snapshot) => {
              const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setTransactions(data);
            }, (error) => {
              console.error("Sync error:", error);
            });
          return () => unsubscribe();
        }
      }, [firebaseHook.isConfigured, firebaseHook.user, firebaseHook.db]);

      // Save to LocalStorage whenever transactions change (Backup & Local Mode)
      useEffect(() => {
        // If we are in local mode, we MUST save. 
        // If we are in cloud mode, we also save to local as a cache/backup, 
        // but we don't want to overwrite local data with empty array on initial load.
        if (transactions.length > 0 || !firebaseHook.isConfigured) {
          localStorage.setItem('shop_ledger_transactions', JSON.stringify(transactions));
        }
      }, [transactions, firebaseHook.isConfigured]);

      // --- ACTIONS ---

      const handleAddTransaction = async (newTx) => {
        setIsSaving(true);
        const transaction = {
          ...newTx,
          id: crypto.randomUUID(),
          date: new Date().toISOString()
        };

        if (firebaseHook.isConfigured && firebaseHook.user) {
          // Save to Cloud
          try {
            await firebaseHook.db
              .collection('users')
              .doc(firebaseHook.user.uid)
              .collection('transactions')
              .doc(transaction.id)
              .set(transaction);
            // No need to setTransactions manually, onSnapshot will trigger
          } catch (e) {
            alert("åŒæ­¥å¤±è´¥: " + e.message);
          }
        } else {
          // Save to Local
          setTransactions(prev => [...prev, transaction]);
        }
        setIsSaving(false);
      };

      const handleDeleteTransaction = async (id) => {
        if (!window.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;

        if (firebaseHook.isConfigured && firebaseHook.user) {
          try {
             await firebaseHook.db
              .collection('users')
              .doc(firebaseHook.user.uid)
              .collection('transactions')
              .doc(id)
              .delete();
          } catch(e) {
            alert("åˆ é™¤å¤±è´¥: " + e.message);
          }
        } else {
          setTransactions(prev => prev.filter(t => t.id !== id));
        }
      };

      const handleImportData = (event) => {
        const file = event.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if (!Array.isArray(json)) throw new Error("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šè¯·ä¸Šä¼  JSON æ•°ç»„æ ¼å¼çš„å¤‡ä»½æ–‡ä»¶");

                // Basic validation
                const validItems = json.filter(t => t.amount && t.type && t.date);
                if (validItems.length === 0) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆçš„è´¦å•æ•°æ®");

                if (!confirm(`å‡†å¤‡å¯¼å…¥ ${validItems.length} æ¡è®°å½•ï¼Ÿ\n\næ³¨æ„ï¼š\n1. ID ç›¸åŒçš„è®°å½•å°†è¢«è¦†ç›–\n2. æ–°çš„è®°å½•å°†è¢«æ·»åŠ `)) {
                    event.target.value = '';
                    return;
                }

                setIsSaving(true);

                if (firebaseHook.isConfigured && firebaseHook.user) {
                    // Cloud Import (Batching)
                    const BATCH_SIZE = 450;
                    const chunks = [];
                    for(let i=0; i<validItems.length; i+=BATCH_SIZE) {
                        chunks.push(validItems.slice(i, i+BATCH_SIZE));
                    }
                    
                    let importedCount = 0;
                    for (const chunk of chunks) {
                        const batch = firebaseHook.db.batch();
                        chunk.forEach(item => {
                            const id = item.id || crypto.randomUUID();
                            const docRef = firebaseHook.db.collection('users').doc(firebaseHook.user.uid).collection('transactions').doc(id);
                            batch.set(docRef, { ...item, id });
                        });
                        await batch.commit();
                        importedCount += chunk.length;
                    }
                    alert(`âœ… æˆåŠŸå°† ${importedCount} æ¡è®°å½•åŒæ­¥åˆ°äº‘ç«¯ï¼`);
                } else {
                    // Local Import
                    setTransactions(prev => {
                        const map = new Map(prev.map(t => [t.id, t]));
                        validItems.forEach(item => {
                            const id = item.id || crypto.randomUUID();
                            map.set(id, { ...item, id });
                        });
                        return Array.from(map.values());
                    });
                    alert(`âœ… æˆåŠŸå¯¼å…¥ ${validItems.length} æ¡è®°å½•ï¼`);
                }

            } catch (err) {
                alert("å¯¼å…¥å¤±è´¥: " + err.message);
            } finally {
                setIsSaving(false);
                if (fileInputRef.current) fileInputRef.current.value = '';
            }
        };
        reader.readAsText(file);
      };

      const totalIncome = transactions.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
      const totalExpense = transactions.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);

      // --- RENDER ---
      return (
        <div className="min-h-screen bg-slate-50 pb-20">
          <ConfigModal 
            isOpen={isModalOpen} 
            onClose={() => setIsModalOpen(false)} 
            firebaseHook={firebaseHook} 
          />

          <header className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="text-3xl animate-bounce" style={{animationDuration: '2s'}}>ğŸª</span>
                <h1 className="text-xl font-black bg-gradient-to-r from-brand-600 to-indigo-600 bg-clip-text text-transparent">
                  ç½‘åº—è´¦å•åŠ©æ‰‹
                </h1>
                <span className="hidden md:inline-block ml-2 px-2 py-0.5 rounded-full bg-slate-100 text-[10px] text-slate-500 font-bold border border-slate-200 uppercase tracking-wide">
                  {firebaseHook.user ? 'CLOUD SYNC' : 'OFFLINE'}
                </span>
              </div>
              
              <div className="flex items-center gap-4">
                <button 
                  onClick={() => setIsModalOpen(true)}
                  className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all ${
                    firebaseHook.isConfigured && firebaseHook.user
                      ? 'bg-emerald-50 text-emerald-600 border border-emerald-200'
                      : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                  }`}
                >
                  <span className={`w-2 h-2 rounded-full ${firebaseHook.user ? 'bg-emerald-500' : 'bg-slate-400'}`}></span>
                  {firebaseHook.user ? 'å·²åŒæ­¥' : 'äº‘åŒæ­¥è®¾ç½®'}
                </button>

                {/* Import Button */}
                <input 
                    type="file" 
                    ref={fileInputRef} 
                    onChange={handleImportData} 
                    className="hidden" 
                    accept=".json" 
                />
                <button 
                  onClick={() => fileInputRef.current?.click()}
                  className="text-xs text-slate-500 hover:text-brand-600 underline"
                  title="æ”¯æŒå¯¼å…¥ .json å¤‡ä»½æ–‡ä»¶"
                >
                  å¯¼å…¥æ•°æ®
                </button>

                <button 
                  onClick={() => {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href",     dataStr);
                    downloadAnchorNode.setAttribute("download", "ledger_backup.json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                  }}
                  className="text-xs text-slate-500 hover:text-brand-600 underline"
                >
                  æœ¬åœ°å¤‡ä»½
                </button>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
              <div className="lg:col-span-4 lg:relative">
                <TransactionForm onAddTransaction={handleAddTransaction} isSaving={isSaving} />
              </div>

              <div className="lg:col-span-8 space-y-8">
                {firebaseHook.isConfigured && !firebaseHook.user && (
                   <div className="bg-blue-50 border border-blue-200 rounded-2xl p-4 flex items-center justify-between">
                     <div className="flex items-center gap-3">
                       <span className="text-2xl">â˜ï¸</span>
                       <div>
                         <p className="font-bold text-blue-900">äº‘ç«¯æ¨¡å¼å·²å°±ç»ª</p>
                         <p className="text-xs text-blue-700">è¯·å…ˆç™»å½• Google è´¦å·ä»¥åŠ è½½æ‚¨çš„äº‘ç«¯æ•°æ®</p>
                       </div>
                     </div>
                     <button onClick={() => setIsModalOpen(true)} className="px-4 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700">å»ç™»å½•</button>
                   </div>
                )}
                
                <StatsOverview totalIncome={totalIncome} totalExpense={totalExpense} />
                <AnalysisCharts transactions={transactions} />
                <TransactionList 
                  transactions={transactions} 
                  onDelete={handleDeleteTransaction} 
                  isReadOnly={isSaving}
                />
              </div>
            </div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>